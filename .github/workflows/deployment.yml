name: Deploy on Staging (automatic) + Production (with approval)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: read
  pages: write
  id-token: write
  actions: write
  statuses: write

concurrency:
  group: "pages-deploy"
  cancel-in-progress: true

jobs:

  package_site:
    runs-on: ubuntu-latest
    name: Package Static Site

    steps:
      - uses: actions/checkout@v4

      - name: Upload Pages artifact (static site)
        uses: actions/upload-pages-artifact@v3
        with:
          path: src

  deploy_staging:
    needs: package_site
    runs-on: ubuntu-latest
    name: Deploy to Staging
    environment:
      name: staging
      url: https://jmiguelcheq.github.io/calculator-demo-staging/

    steps:
      - name: Download Pages artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: site

      - name: Extract artifact
        run: |
          set -e
          tar -xf site/artifact.tar -C site
          rm site/artifact.tar

      - name: Checkout staging repo (main)
        uses: actions/checkout@v4
        with:
          repository: jmiguelcheq/calculator-demo-staging
          ref: main
          token: ${{ secrets.CI_PAT }}
          path: staging

      - name: Sync artifact contents to staging
        run: |
          set -e
          cd staging

          find . -mindepth 1 -maxdepth 1 \
            ! -name '.git' \
            ! -name 'README.md' \
            -exec rm -rf {} +

          cp -R ../site/* .

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep .; then
            git add .
            git commit -m "Deploy staging from ${GITHUB_SHA}"
            git push origin main
          else
            echo "No changes to deploy to staging."
          fi

  smoke_test_staging:
    needs: deploy_staging
    runs-on: ubuntu-latest
    name: Run Smoke Tests on Staging

    steps:
      - name: Trigger smoke tests via repository_dispatch (staging URL)
        id: send_smoke_tests
        uses: actions/github-script@v7
        env:
          TARGET_OWNER: "jmiguelcheq"
          TARGET_REPO: "calculator-test-demo"
          STAGING_URL: "https://jmiguelcheq.github.io/calculator-demo-staging"
        with:
          github-token: ${{ secrets.CI_PAT }}
          script: |
            const payload = {
              calc_url: process.env.STAGING_URL,
              environment: 'staging',
              source_repo: `${context.repo.owner}/${context.repo.repo}`,
              sha: context.sha,
              ref: context.ref.replace('refs/heads/', '')
            };

            await github.rest.repos.createDispatchEvent({
              owner: process.env.TARGET_OWNER,
              repo: process.env.TARGET_REPO,
              event_type: 'run-tests',
              client_payload: payload
            });

            core.info(`Smoke tests dispatched with payload: ${JSON.stringify(payload)}`);
            core.setOutput("dispatched_at", new Date().toISOString());

      - name: Wait for smoke tests to finish
        id: wait_smoke_tests
        uses: actions/github-script@v7
        env:
          TARGET_OWNER: "jmiguelcheq"
          TARGET_REPO: "calculator-test-demo"
          DISPATCHED_AT: ${{ steps.send_smoke_tests.outputs.dispatched_at }}
        with:
          github-token: ${{ secrets.CI_PAT }}
          script: |
            const { TARGET_OWNER, TARGET_REPO, DISPATCHED_AT } = process.env;
            const workflow_id = 'on-dispatch-tests.yml';
            const deadline = Date.now() + 20 * 60 * 1000;
            const dispatchedAtMs = Date.parse(DISPATCHED_AT);

            let runId, run;
            while (Date.now() < deadline) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: TARGET_OWNER,
                repo: TARGET_REPO,
                workflow_id,
                event: 'repository_dispatch',
                per_page: 20
              });
              const match = runs.data.workflow_runs.find(r => Date.parse(r.created_at) >= dispatchedAtMs);
              if (match) {
                runId = match.id;
                core.info(`Found smoke test run: ${runId}`);
                break;
              }
              await new Promise(r => setTimeout(r, 5000));
            }

            if (!runId) core.setFailed("Smoke test run not found.");

            while (Date.now() < deadline) {
              const res = await github.rest.actions.getWorkflowRun({
                owner: TARGET_OWNER,
                repo: TARGET_REPO,
                run_id: runId
              });
              run = res.data;
              core.info(`status=${run.status}, conclusion=${run.conclusion}`);

              if (run.status === 'completed') break;
              await new Promise(r => setTimeout(r, 10000));
            }

            core.setOutput('run_url', run.html_url);
            core.setOutput('conclusion', run.conclusion);

            if (run.conclusion !== 'success') {
              core.setFailed(`Staging smoke tests FAILED: ${run.conclusion}`);
            }

  deploy_production:
    needs: [package_site, deploy_staging, smoke_test_staging]
    runs-on: ubuntu-latest
    name: Deploy to Production
    environment:
      name: production
      url: https://jmiguelcheq.github.io/calculator-demo/

    steps:
      - name: Deploy to GitHub Pages (Production)
        uses: actions/deploy-pages@v4
